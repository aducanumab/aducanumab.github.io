<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>mouse over console</title>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    let map;

    function initMap() {
      const mapCenter = { lat: 37.5665, lng: 126.9780 }; // 초기 중심 좌표
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12, // 초기 줌 레벨
        center: mapCenter,
      });

      // --- KML 레이어 추가 부분 ---

      // 매번 다른 값을 가지는 '캐시 버스터' 변수 생성
      const cacheBuster = new Date().getTime();
      
      // 1. GitHub에 업로드한 KML 파일의 전체 주소를 지정합니다.
      // '본인ID'와 'map_data.kml' 부분은 실제 값으로 변경해야 합니다.
      // const kmlUrl = 'https://aducanumab.github.io/map_data.kml';
      const kmlUrl = `https://raw.githubusercontent.com/aducanumab/aducanumab.github.io/refs/heads/main/map_data.kml?v=${cacheBuster}`;

      // 2. KML 레이어를 생성하여 지도에 추가합니다.
      const kmlLayer = new google.maps.KmlLayer({
        url: kmlUrl,
        map: map,
        preserveViewport: false // KML 데이터에 맞춰 지도가 멋대로 줌인/아웃되는 것을 방지
      });
      // --------------------------

      // KML 레이어에 'click' 이벤트 리스너를 추가합니다.
      kmlLayer.addListener('click', (kmlEvent) => {
        // 1. 클릭된 폴리곤의 정보창(description) HTML 내용을 가져옵니다.
        const infoWindowContent = kmlEvent.featureData.infoWindowHtml;
      
        // 2. 정규식을 사용해 HTML 내용에서 href="..." 안에 있는 URL을 추출합니다.
        const urlMatch = infoWindowContent.match(/<a\s+(?:[^>]*?\s+)?href="([^"]*)"/i);
      
        // 3. 추출된 URL이 있다면, 해당 페이지로 브라우저를 이동시킵니다.
        if (urlMatch && urlMatch[1]) {
          const url = urlMatch[1];
          console.log('페이지 이동:', url); // (디버깅용) 콘솔에 이동할 주소 출력
          window.location.href = url;
        } else {
          console.log('이 폴리곤에는 연결된 URL이 없습니다.'); // (디버깅용)
        }
      });
      // --------------------------

      // --- ↓↓↓ 마우스 오버 기능 추가 ↓↓↓ ---
      
      // 1. 재사용할 정보창(InfoWindow) 객체를 미리 하나 생성합니다.
      const infoWindow = new google.maps.InfoWindow();
      
      // 2. KML 레이어에 'mouseover' 이벤트 리스너를 추가합니다.
      kmlLayer.addListener('mouseover', (kmlEvent) => {

        console.log(kmlEvent.featureData);
        
        // 마우스 커서의 위치와 폴리곤의 정보를 가져옵니다.
        const latLng = kmlEvent.latLng;
        const featureData = kmlEvent.featureData;
      
        // 정보창의 내용을 폴리곤의 이름으로 설정합니다.
        infoWindow.setContent(`<div>${featureData.name}</div>`);
        // 정보창의 위치를 마우스 커서 위치로 설정합니다.
        infoWindow.setPosition(latLng);
        // 정보창을 지도에 표시합니다.
        infoWindow.open(map);

      });
      
      // 3. KML 레이어에 'mouseout' 이벤트 리스너를 추가합니다.
      kmlLayer.addListener('mouseout', () => {
        // 마우스가 폴리곤에서 벗어나면 정보창을 닫습니다.
        infoWindow.close();
      });
      // --------------------------
      
    }

    async function loadMap() {
      // Netlify 함수를 통해 안전하게 API 키를 불러오는 부분 (이전과 동일)
      try {
        const response = await fetch('/.netlify/functions/get-api-key');
        const data = await response.json();
        const apiKey = data.apiKey;

        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
        script.async = true;
        document.head.appendChild(script);
      } catch (error) {
        console.error('API 키를 불러오는 데 실패했습니다.', error);
      }
    }

    loadMap();
  </script>
</body>
</html>
