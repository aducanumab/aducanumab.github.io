<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Final Interactive Map</title>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .gm-style-iw-c { padding: 0 !important; }
    .gm-style-iw-d { overflow: hidden !important; }
    .custom-infowindow-content {
      font-family: 'Nanum Gothic', sans-serif;
      font-size: 18px;
      font-weight: bold;
      padding: 12px 15px;
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
</head>
<body>
  <div id="map"></div>

  <script>
    let map;
    // infoWindow 변수는 바깥에 선언만 해둡니다.
    let infoWindow;

    function initMap() {
      // --- ▼▼▼ 오류 수정 ▼▼▼ ---
      // Google API가 로드된 것이 보장되는 이 시점에서 infoWindow 객체를 생성합니다.
      infoWindow = new google.maps.InfoWindow();
      // --- ▲▲▲ 오류 수정 ▲▲▲ ---

      const mapCenter = { lat: 37.5665, lng: 126.9780 };
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        center: mapCenter,
      });
      loadAndProcessKml();
    }

    async function loadAndProcessKml() {
      const initialKmlUrl = 'https://raw.githubusercontent.com/aducanumab/aducanumab.github.io/refs/heads/main/map_data.kml';
      
      try {
        const initialResponse = await fetch(initialKmlUrl);
        if (!initialResponse.ok) throw new Error(`초기 KML 로딩 실패`);
        const initialKmlText = await initialResponse.text();
        const parser = new DOMParser();
        const initialKmlDoc = parser.parseFromString(initialKmlText, "application/xml");
        const kmlNs = 'http://www.opengis.net/kml/2.2';
        const hrefElem = initialKmlDoc.getElementsByTagNameNS(kmlNs, 'href')[0];
        if (!hrefElem) throw new Error('NetworkLink href를 찾을 수 없습니다.');
        
        const finalKmlUrl = hrefElem.textContent;

        const finalResponse = await fetch(finalKmlUrl);
        if (!finalResponse.ok) throw new Error(`최종 KML 로딩 실패`);
        const finalKmlText = await finalResponse.text();
        const finalKmlDoc = parser.parseFromString(finalKmlText, "application/xml");

        const styles = {};
        const styleMaps = {};
        
        const styleMapElements = finalKmlDoc.getElementsByTagNameNS(kmlNs, 'StyleMap');
        for (let i = 0; i < styleMapElements.
