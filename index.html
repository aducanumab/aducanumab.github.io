<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Map with Polygon Labels</title>
  <style>
    /* 웹페이지의 기본 여백을 없애고, 지도가 화면을 꽉 채우도록 설정합니다. */
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    let map;

    // Google Maps API 스크립트가 로드된 후 실행될 기본 함수입니다.
    function initMap() {
      // 1. 지도의 초기 중심 좌표와 줌 레벨을 설정합니다. (예: 서울 시청)
      const mapCenter = { lat: 37.5665, lng: 126.9780 };
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        center: mapCenter,
      });

      // 2. KML 파일을 불러와서 처리하는 메인 함수를 호출합니다.
      loadAndProcessKml();
    }

    // KML 파일을 불러오고, 파싱하여 폴리곤과 라벨을 생성하는 비동기 함수
    async function loadAndProcessKml() {
      // '본인ID' 부분은 실제 GitHub ID로 변경해야 합니다.
      const kmlUrl = 'https://raw.githubusercontent.com/본인ID/본인ID.github.io/main/map_data.kml';
      
      try {
        // 1. fetch API를 사용해 GitHub에 있는 KML 파일을 텍스트로 불러옵니다.
        const response = await fetch(kmlUrl);
        if (!response.ok) {
          throw new Error(`KML 파일을 불러오는 데 실패했습니다: ${response.statusText}`);
        }
        const kmlText = await response.text();

        // 2. 불러온 KML 텍스트를 XML 문서로 파싱합니다.
        const parser = new DOMParser();
        const kmlDoc = parser.parseFromString(kmlText, "application/xml");

        // 3. KML 문서 안의 모든 Placemark(도형 데이터 묶음)를 찾습니다.
        const placemarks = kmlDoc.getElementsByTagName('Placemark');

        // 4. 각 Placemark를 순회하며 폴리곤과 라벨을 생성합니다.
        for (let i = 0; i < placemarks.length; i++) {
          const placemark = placemarks[i];
          const name = placemark.getElementsByTagName('name')[0].textContent;
          const coordinatesStr = placemark.getElementsByTagName('coordinates')[0].textContent.trim();
          
          // 5. KML의 좌표 텍스트를 구글맵이 이해할 수 있는 좌표 객체 배열로 변환합니다.
          const path = coordinatesStr.split(/\s+/).map(coordStr => {
            const [lng, lat] = coordStr.split(',');
            // 유효한 좌표값인지 확인
            if (!isNaN(parseFloat(lat)) && !isNaN(parseFloat(lng))) {
              return { lat: parseFloat(lat), lng: parseFloat(lng) };
            }
          }).filter(p => p); // 유효하지 않은 좌표는 걸러냅니다.

          if (path.length === 0) continue; // 유효한 좌표가 없으면 다음으로 넘어갑니다.

          // 6. 구글맵 폴리곤 객체를 생성하고 지도에 추가합니다.
          const polygon = new google.maps.Polygon({
            paths: path,
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#FF0000",
            fillOpacity: 0.35,
            map: map
          });

          // 7. 폴리곤의 중심점을 계산하여 라벨을 표시할 위치를 정합니다.
          const center = getPolygonCenter(path);

          // 8. 아이콘은 투명하게 하고, 텍스트 라벨만 보이도록 마커를 생성합니다.
          const labelMarker = new google.maps.Marker({
            position: center,
            map: map,
            label: {
              text: name,
              color: 'black',
              fontSize: '12px',
              fontWeight: 'bold'
            },
            icon: {
              path: 'M 0,0', // 보이지 않는 점
              strokeOpacity: 0,
              scale: 0
            }
          });
        }
      } catch (error) {
        console.error('KML 데이터를 처리하는 중 오류가 발생했습니다.', error);
        alert('지도 데이터를 불러오는 데 문제가 발생했습니다. 콘솔을 확인해 주세요.');
      }
    }

    // 폴리곤의 기하학적 중심 좌표를 계산하는 도우미 함수입니다.
    function getPolygonCenter(path) {
      const bounds = new google.maps.LatLngBounds();
      path.forEach(point => bounds.extend(point));
      return bounds.getCenter();
    }
    
    // Netlify 서버리스 함수를 통해 API 키를 안전하게 불러오는 함수입니다.
    async function loadMap() {
      try {
        const response = await fetch('/.netlify/functions/get-api-key');
        const data = await response.json();
        const apiKey = data.apiKey;

        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&loading=async`;
        script.async = true;
        document.head.appendChild(script);
      } catch (error) {
        console.error('API 키를 불러오는 데 실패했습니다.', error);
        alert('API 키를 불러오는 데 실패했습니다. 사이트 설정을 확인해 주세요.');
      }
    }

    // 페이지가 열리면 지도 로딩을 시작합니다.
    loadMap();
  </script>
</body>
</html>
