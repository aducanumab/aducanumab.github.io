<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Map with Polygon Labels (Fixed)</title>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    let map;

    function initMap() {
      const mapCenter = { lat: 37.5665, lng: 126.9780 };
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        center: mapCenter,
      });
      loadAndProcessKml();
    }

    async function loadAndProcessKml() {
      const kmlUrl = 'https://raw.githubusercontent.com/aducanumab/aducanumab.github.io/refs/heads/main/map_data.kml';
      
      try {
        const response = await fetch(kmlUrl);
        if (!response.ok) {
          throw new Error(`KML 파일을 불러오는 데 실패했습니다: ${response.statusText}`);
        }
        const kmlText = await response.text();
        console.log("1. KML 파일 로딩 성공"); // 디버깅 로그

        const parser = new DOMParser();
        const kmlDoc = parser.parseFromString(kmlText, "application/xml");

        // --- 수정된 부분: getElementsByTagNameNS 사용 ---
        const kmlNs = 'http://www.opengis.net/kml/2.2'; // KML 네임스페이스 주소
        const placemarks = kmlDoc.getElementsByTagNameNS(kmlNs, 'Placemark');
        console.log(`2. Placemark 찾기 결과: ${placemarks.length}개 발견`); // 디버깅 로그

        if (placemarks.length === 0) {
          alert('KML 파일에서 Placemark(도형) 데이터를 찾지 못했습니다. 파일 형식을 확인해주세요.');
          return;
        }

        for (let i = 0; i < placemarks.length; i++) {
          const placemark = placemarks[i];
          const name = placemark.getElementsByTagNameNS(kmlNs, 'name')[0].textContent;
          const coordinatesElem = placemark.getElementsByTagNameNS(kmlNs, 'coordinates')[0];
          
          if (!coordinatesElem) continue; // coordinates 태그가 없는 경우 건너뛰기
          
          const coordinatesStr = coordinatesElem.textContent.trim();
          
          const path = coordinatesStr.split(/\s+/).map(coordStr => {
            const [lng, lat] = coordStr.split(',');
            if (!isNaN(parseFloat(lat)) && !isNaN(parseFloat(lng))) {
              return { lat: parseFloat(lat), lng: parseFloat(lng) };
            }
          }).filter(p => p);

          if (path.length === 0) continue;

          const polygon = new google.maps.Polygon({
            paths: path,
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#FF0000",
            fillOpacity: 0.35,
            map: map
          });

          const center = getPolygonCenter(path);

          const labelMarker = new google.maps.Marker({
            position: center,
            map: map,
            label: {
              text: name,
              color: 'black',
              fontSize: '12px',
              fontWeight: 'bold'
            },
            icon: {
              path: 'M 0,0',
              strokeOpacity: 0,
              scale: 0
            }
          });
        }
        console.log("3. 폴리곤 및 라벨 생성 완료"); // 디버깅 로그
      } catch (error) {
        console.error('KML 데이터를 처리하는 중 오류가 발생했습니다.', error);
        alert('지도 데이터를 불러오는 데 문제가 발생했습니다. F12를 눌러 콘솔을 확인해 주세요.');
      }
    }

    function getPolygonCenter(path) {
      const bounds = new google.maps.LatLngBounds();
      path.forEach(point => bounds.extend(point));
      return bounds.getCenter();
    }
    
    async function loadMap() {
      try {
        const response = await fetch('/.netlify/functions/get-api-key');
        const data = await response.json();
        const apiKey = data.apiKey;

        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&loading=async`;
        script.async = true;
        document.head.appendChild(script);
      } catch (error) {
        console.error('API 키를 불러오는 데 실패했습니다.', error);
        alert('API 키를 불러오는 데 실패했습니다. 사이트 설정을 확인해 주세요.');
      }
    }

    loadMap();
  </script>
</body>
</html>
